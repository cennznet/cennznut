version: 2.1
jobs:
  built-and-tested:
    docker:
      - image: circleci/rust:1.37.0
    steps:
      - run: echo "successfully built and tested"
  build:
    docker:
      - image: circleci/rust:1.37.0
    steps:
      - checkout
      - run:
          name: setup
          command: |
            rustup component add rustfmt --toolchain 1.37.0-x86_64-unknown-linux-gnu
            rustup install nightly
      - run:
          name: cargo check
          command: |
            cargo --version --verbose
            cargo check
      - run:
          name: cargo fmt
          command: |
            cargo fmt --version
            cargo fmt -- --check
      - run:
          name: "Check 'no std' build"
          command: |
            cargo +nightly --version --verbose
            cargo +nightly check --no-default-features
  test:
    docker:
      - image: circleci/rust:1.37.0
    steps:
      - checkout
      - run:
          name: setup
          command: |
            rustup install nightly
      - run:
          name: cargo test
          command: |
            cargo test
  clippy:
    docker:
      - image: circleci/rust:1.37.0
    steps:
      - checkout
      - run:
          name: setup
          command: |
            rustup component add clippy --toolchain 1.37.0-x86_64-unknown-linux-gnu
            rustup install nightly
      - run:
          name: cargo clippy
          command: |
            cargo clean
            cargo clippy -- -D warnings
workflows:
  version: 2
  build-test-clippy:
    jobs:
      - build
      - test
      - clippy
      - built-and-tested:
          requires:
            - build
            - test
            - clippy
